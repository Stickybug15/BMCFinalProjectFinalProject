rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the requesting user is an admin.
    // It reads the 'isAdmin' field from the user's document in the 'users' collection.
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Rules for the 'users' collection.
    match /users/{userId} {
      // Allow any authenticated user to create their own user document (e.g., on sign-up).
      allow create: if request.auth != null;
      // Allow users to read or update their own document.
      // Admins are also allowed to read or update any user's document.
      allow read, update: if request.auth.uid == userId || isAdmin();
    }

    // Rules for the 'products' collection.
    match /products/{productId} {
      // Allow anyone (authenticated or not) to view the products.
      allow read: if true;
      // Only allow admins to create, update, or delete products.
      allow write: if isAdmin();
    }
    
    // Rules for the 'userCarts' collection.
    match /userCarts/{userId} {
        // Users can only read and write to their own shopping cart.
        allow read, write: if request.auth.uid == userId;
    }

    // Rules for the 'orders' collection.
    match /orders/{orderId} {
        // Users can read their own orders. Admins can read any order.
        allow read: if request.auth.uid == resource.data.userId || isAdmin();
        // Allow authenticated users to create new orders for themselves.
        allow create: if request.auth.uid == request.resource.data.userId;
        // Only allow admins to update an order's status.
        allow update: if isAdmin();
    }
    
    // Rules for the 'notifications' collection.
    match /notifications/{notificationId} {
        // Users can read notifications intended for them. Admins can read all notifications.
        allow read: if request.auth.uid == resource.data.userId || isAdmin();
        // Allow authenticated users to create notifications for themselves (as used when placing an order).
        allow create: if request.auth.uid == request.resource.data.userId;
    }

    // Rules for the 'chats' collection itself.
    match /chats/{chatRoomId} {
        // Explicitly grant admins permission to list all chats
        allow list: if isAdmin();
        // Grant users access to their own chat and admins access to any chat
        allow get: if request.auth.uid == chatRoomId || isAdmin();
        // Allow users to write to their own chat and admins to any chat
        allow write: if request.auth.uid == chatRoomId || isAdmin();
    }

    // Rules for the subcollection of messages within a chat.
    match /chats/{chatRoomId}/messages/{messageId} {
      // Allow a user to read and write messages if their user ID matches the chat room ID.
      // This is for the user's side of the chat.
      // Also, allow admins to read and write to any chat room. This is for the admin's side.
      allow read, write: if request.auth.uid == chatRoomId || isAdmin();
    }
  }
}
